# Bundle Size Analysis
#
# NOTE: Turbopack limitation (see GitHub issue #303)
#
# Next.js builds with Turbopack (the default in dev and increasingly in
# production) do NOT emit per-route JavaScript sizes in the build output.
# The classic Webpack-based build prints a table like:
#
#   Route                              Size     First Load JS
#   /                                  5.2 kB         89 kB
#   /u/[handle]                        3.1 kB         87 kB
#
# Turbopack omits this entirely. As a result, this workflow measures
# aggregate directory sizes (.next/static, .next/server, total) and lists
# the largest individual JS files â€” but cannot report per-route First Load
# JS budgets.
#
# For detailed per-route analysis, run locally with Webpack:
#   ANALYZE=true pnpm --filter web build
# This requires @next/bundle-analyzer to be configured in next.config.ts.
#
# Turbopack tracking: https://github.com/vercel/next.js/issues/49887

name: Bundle Size Analysis

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop, main]

jobs:
  analyze:
    name: Analyze Bundle Size
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build
        env:
          GITHUB_CLIENT_ID: dummy
          GITHUB_CLIENT_SECRET: dummy
          NEXTAUTH_SECRET: dummy-secret-for-ci
          UPSTASH_REDIS_REST_URL: https://dummy.upstash.io
          UPSTASH_REDIS_REST_TOKEN: dummy

      - name: Analyze bundle
        id: bundle
        working-directory: apps/web
        run: |
          echo "## Bundle Size Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Directory | Size |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|------|" >> "$GITHUB_STEP_SUMMARY"

          if [ -d ".next/static" ]; then
            STATIC_SIZE=$(du -sh .next/static | cut -f1)
            echo "| \`.next/static\` | $STATIC_SIZE |" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ -d ".next/server" ]; then
            SERVER_SIZE=$(du -sh .next/server | cut -f1)
            echo "| \`.next/server\` | $SERVER_SIZE |" >> "$GITHUB_STEP_SUMMARY"
          fi

          TOTAL_SIZE=$(du -sh .next | cut -f1)
          echo "| **Total \`.next\`** | **$TOTAL_SIZE** |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### Largest JS bundles" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          find .next -name "*.js" -type f -exec du -h {} + | sort -rh | head -20 >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

          echo "static_size=${STATIC_SIZE:-N/A}" >> "$GITHUB_OUTPUT"
          echo "server_size=${SERVER_SIZE:-N/A}" >> "$GITHUB_OUTPUT"
          echo "total_size=${TOTAL_SIZE}" >> "$GITHUB_OUTPUT"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const staticSize = '${{ steps.bundle.outputs.static_size }}';
            const serverSize = '${{ steps.bundle.outputs.server_size }}';
            const totalSize = '${{ steps.bundle.outputs.total_size }}';

            const body = [
              '## Bundle Size Report',
              '',
              '| Directory | Size |',
              '|-----------|------|',
              `| \`.next/static\` | ${staticSize} |`,
              `| \`.next/server\` | ${serverSize} |`,
              `| **Total \`.next\`** | **${totalSize}** |`,
              '',
              `> Measured at commit ${context.sha.substring(0, 7)}`,
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = '## Bundle Size Report';
            const existing = comments.find(c => c.body.startsWith(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
